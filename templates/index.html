<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gargona</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="navbar">
        <ul>
            <li><a href="#home">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="#news">–ö–∞—Ç–∞–ª–æ–≥</a></li>
            <li><a href="#contact">–ù–∞—à–∏ —Ä–∞–±–æ—Ç—ã</a></li>
            <li><a href="#about">–û –Ω–∞—Å</a></li>
        </ul>
    </div>
    
    <div id="startContainer" style="text-align: center; margin-top: 20%;">
        <button id="startButton">–°—Ç–∞—Ä—Ç</button>
    </div>

    <div id="chatContainer" style="display: none;">
        <input type="text" placeholder="–í–∞—à –∑–∞–ø—Ä–æ—Å..." id="input_text">
        <button id="sendButton">‚Üë</button>
        <div id="chat"></div>
    
        <div class="button-container">
            <button class="button" data-question="1">–ö–∞–∫–∏–µ –∫–∞–º–Ω–∏ —É –≤–∞—Å –µ—Å—Ç—å?</button>
            <button class="button" data-question="2">–°–∫–æ–ª—å–∫–æ –≤ —Å—Ä–µ–¥–Ω–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞?</button>
            <button class="button" data-question="3">–°–∫–æ–ª—å–∫–æ –∫–∞–º–Ω–µ–π —É –≤–∞—Å –∏–∑ –†–æ—Å—Å–∏–∏?</button>
            <button id="contactButton" class="button">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –¥–ª—è —Å–≤—è–∑–∏</button>
            <input type="file" id="file_input" accept=".txt,.pdf,.xlsx,.docx" style="display: none;">
            <button id="uploadButton">üìÅ</button>
        </div>
    
        <div id="phoneInputContainer" style="display: none;">
            <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" id="nameInput">
            <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" id="phoneInput">
            <button id="submitButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <script>
        $(document).ready(function() {
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const ERROR_MESSAGE = '–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
    $('#startButton').click(initializeChat);

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    $('#sendButton').click(sendMessage);
    $('#input_text').keypress(function(e) {
        if (e.which === 13) sendMessage();
    });

    // –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤
    $('.quick-question').click(function() {
        const question = $(this).text();
        processUserMessage(question);
    });

    // –§–æ—Ä–º–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    $('#contactButton').click(function() {
        $('#contactFormContainer').toggleClass('d-none');
    });

    $('#submitContact').click(submitContactForm);

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å)
    $('#uploadButton').click(function() {
        $('#file_input').click();
    });

    $('#file_input').change(handleFileUpload);

    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function initializeChat() {
        $('#startContainer').hide();
        $('#chatContainer').show();
        
        $.post('/start')
            .done(function(data) {
                addMessage(data.text, 'bot');
            })
            .fail(handleError);
    }

    function sendMessage() {
        const message = $('#input_text').val().trim();
        if (!message) return;
        
        processUserMessage(message);
        $('#input_text').val('');
    }

    function processUserMessage(message) {
        addMessage(message, 'user');
        
        $.post('/chat', { message: message })
            .done(function(data) {
                if (data.error) {
                    addMessage(ERROR_MESSAGE, 'bot');
                    console.error('Server error:', data.error);
                } else {
                    addMessage(data.text, 'bot');
                }
            })
            .fail(handleError);
    }

    function submitContactForm() {
        const name = $('#nameInput').val().trim();
        const phone = $('#phoneInput').val().trim();
        
        if (!name || !phone) {
            showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.', 'warning');
            return;
        }
        
        $.post('/submit_contact', { name: name, phone: phone })
            .done(function(data) {
                if (data.status === 'success') {
                    showAlert('‚úÖ ' + data.message, 'success');
                    resetContactForm();
                } else {
                    showAlert('‚ö†Ô∏è ' + data.message, data.status || 'warning');
                }
            })
            .fail(function() {
                showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'danger');
            });
    }

    function handleFileUpload() {
        const file = this.files[0];
        if (!file) return;
        
        const instructions = prompt("–í–≤–µ–¥–∏—Ç–µ —É–∫–∞–∑–∞–Ω–∏—è –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:");
        if (!instructions) return;
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('instructions', instructions);
        
        $.ajax({
            url: '/upload_file',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                addMessage(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∞–π–ª: ${file.name}`, 'user');
                addMessage(data.text || ERROR_MESSAGE, 'bot');
            },
            error: handleError
        });
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function addMessage(text, sender) {
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const messageHtml = `
            <div class="message ${sender}-message">
                <div class="message-content">${text}</div>
                <div class="message-time">${timestamp}</div>
            </div>
        `;
        $('#chat').append(messageHtml);
        $('#chat').scrollTop($('#chat')[0].scrollHeight);
    }

    function showAlert(message, type) {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('#alertsContainer').append(alertHtml);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    function handleError(xhr, status, error) {
        console.error('Error:', status, error);
        addMessage(ERROR_MESSAGE, 'bot');
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'danger');
    }

    function resetContactForm() {
        $('#contactFormContainer').addClass('d-none');
        $('#nameInput').val('');
        $('#phoneInput').val('');
        $('#file_input').val('');
    }
});
    </script>
</body>
</html>